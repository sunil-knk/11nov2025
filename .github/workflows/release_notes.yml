name: Auto Tag and Clean Release Notes (PROD)

on:
  pull_request:
    types: [closed]
    branches:
      - test/PROD

permissions:
  contents: write

jobs:
  create_release:
    if: |
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.title, 'Sprint Release:')
    runs-on: ubuntu-latest

    env:
      TARGET_BRANCH: "test/PROD"
      GITHUB_API: "https://api.github.com"
      REPO: ${{ github.repository }}

    steps:
      # -------------------------------------------------------------------------
      # 1. Determine latest tag using GitHub API
      # -------------------------------------------------------------------------
      - name: Fetch latest tag from API
        id: tagfetch
        env:
          TOKEN: ${{ secrets.SUNIL3 }}
        run: |
          echo "Fetching latest sprint tag via GitHub API..."
          OWNER=$(echo "${REPO}" | cut -d'/' -f1)
          REPO_NAME=$(echo "${REPO}" | cut -d'/' -f2)

          TAGS=$(curl -s -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${OWNER}/${REPO_NAME}/tags" | jq -r '.[].name')

          echo "Existing tags:"
          echo "$TAGS"

          LAST=$(echo "$TAGS" | grep '^sprint_' | sort -V | tail -n1)
          if [ -z "$LAST" ]; then
            NEXT="sprint_1"
          else
            NUM=$(echo "$LAST" | grep -oE '[0-9]+$')
            NEXT="sprint_$((NUM+1))"
          fi

          echo "last_tag=$LAST" >> $GITHUB_OUTPUT
          echo "new_tag=$NEXT" >> $GITHUB_OUTPUT
          echo "Last Tag: $LAST | Next Tag: $NEXT"

      # -------------------------------------------------------------------------
      # 2. Collect only PROD merge commits
      # -------------------------------------------------------------------------
      - name: Collect PROD commits
        id: commits
        env:
          TOKEN: ${{ secrets.SUNIL3 }}
          TARGET_BRANCH: test/PROD
        run: |
          echo "Cloning repository..."
          git clone https://x-access-token:${TOKEN}@github.com/${{ github.repository }} repo
          cd repo
      
          echo "Collecting commits for ${TARGET_BRANCH}..."
          git fetch origin ${TARGET_BRANCH}
          git checkout ${TARGET_BRANCH}
          
          LAST="sprint_12"
          RANGE_ARG=""
          if [ -n "$LAST" ]; then
            RANGE_ARG="${LAST}..HEAD"
          fi
      
          git log $RANGE_ARG --pretty=format:"%s" \
            | grep -E "merge pull request #[0-9]+.*from.*/release/test" \
            > commits.txt || true
      
          if [ ! -s commits.txt ]; then
            echo "No commits found for this release." > commits.txt
          fi
      
          echo "Release notes:"
          cat commits.txt

      # -------------------------------------------------------------------------
      # 3. Create Release via API (auto creates tag)
      # -------------------------------------------------------------------------
      - name: Create GitHub Release via API
        env:
          TOKEN: ${{ secrets.SUNIL3 }}
          TAG: ${{ steps.tagfetch.outputs.new_tag }}
          TARGET_BRANCH: ${{ env.TARGET_BRANCH }}
          REPO: ${{ env.REPO }}
        run: |
          OWNER=$(echo "$REPO" | cut -d'/' -f1)
          REPO_NAME=$(echo "$REPO" | cut -d'/' -f2)
          BODY=$(cat commits.txt | jq -Rs .)

          echo "Creating release for tag: ${TAG}"

          PAYLOAD=$(jq -n \
            --arg tag "$TAG" \
            --arg target "$TARGET_BRANCH" \
            --arg name "Sprint Release $TAG" \
            --arg body "$(cat commits.txt)" \
            '{ tag_name:$tag, target_commitish:$target, name:$name, body:$body, draft:false, prerelease:false, generate_release_notes:false }')

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.github.com/repos/${OWNER}/${REPO_NAME}/releases" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "Release creation response:"
          echo "$RESPONSE"





