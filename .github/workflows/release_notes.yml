name: Auto Tag and Release (test/PROD only)

on:
  pull_request:
    types: [closed]
    branches:
      - test/PROD

jobs:
  create-release:
    if: >
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.title, 'Sprint Release:') &&
      github.event.pull_request.base.ref == 'test/PROD'
    permissions:
      contents: write  
    runs-on: ubuntu-latest
    env:
      TARGET_BRANCH: "test/PROD"
      GITHUB_API: "https://api.github.com"
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # fetch all history and tags

      - name: Set up Git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "Previous tag: $PREV_TAG"
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Determine Last Tag and Next Tag
        id: tag_calc
        run: |
          # 1. Find the last tag on the *current* branch history.
          # We use 'git describe' to find the most recent tag reachable from the merge commit.
          # The merge commit SHA is: ${{ github.event.pull_request.merge_commit_sha }}
          
          # Find the most recent tag matching 'sprint_*' reachable from the merge commit
          LAST_TAG=$(git describe --tags --match 'sprint_*' --abbrev=0 ${{ github.event.pull_request.merge_commit_sha }} 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            NEXT_TAG="sprint_1"
          else
            # Extract number and increment
            NUM=$(echo "$LAST_TAG" | grep -oE '[0-9]+$' || echo "0")
            NEXT_NUM=$((NUM + 1))
            NEXT_TAG="sprint_${NEXT_NUM}"
          fi
          
          echo "LAST_TAG=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "NEXT_TAG=$NEXT_TAG" >> $GITHUB_OUTPUT
          echo "Calculated next tag: $NEXT_TAG"

      - name: Create GitHub release via REST API (Using generate_release_notes is true)
        env:
          GITHUB_TOKEN: ${{ secrets.SUNIL3 }} # Use default GITHUB_TOKEN
        run: |
          TAG_NAME=${{ steps.tag_calc.outputs.NEXT_TAG }}
          # Target the exact merge commit SHA
          TARGET_COMMITISH=${{ github.event.pull_request.merge_commit_sha }}
          
          echo "Creating release for $TAG_NAME at $TARGET_COMMITISH"
          
          # The API call uses generate_release_notes: true
          curl -s -w "\n%{http_code}" -X POST "https://api.github.com/repos/${{ github.repository }}/releases" \
            -H "Authorization: Bearer ${{ env.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            -d '{
              "tag_name": "'"$TAG_NAME"'",
              "target_commitish": "'"$TARGET_COMMITISH"'", 
              "name": "Release: '"$TAG_NAME"'",
              "body": "Automatically generated notes for features promoted to PROD.",
              "draft": false,
              "prerelease": false,
              "generate_release_notes": true,
              "previous_tag_name": "'"LAST_TAG"'"
            }'
