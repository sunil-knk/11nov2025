name: Auto Tag and Clean Release Notes (PROD)

on:
  pull_request:
    types: [closed]
    branches:
      - test/PROD

permissions:
  contents: write

jobs:
  create_release:
    if: |
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.title, 'Sprint Release:')
    runs-on: ubuntu-latest

    env:
      TARGET_BRANCH: "test/PROD"
      GITHUB_API: "https://api.github.com"
      REPO: ${{ github.repository }}

    steps:
      # -------------------------------------------------------------------------
      # 1. Clone repository (no 'uses:')
      # -------------------------------------------------------------------------
      - name: Clone repository
        env:
          TOKEN: ${{ secrets.SUNIL3 }}
        run: |
          echo "Cloning repository..."
          git clone https://x-access-token:${TOKEN}@github.com/${{ github.repository }} .
          git fetch --tags --prune
          git checkout ${TARGET_BRANCH}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "Repository cloned and configured."

      # -------------------------------------------------------------------------
      # 2. Determine next sprint tag
      # -------------------------------------------------------------------------
      - name: Compute next sprint tag
        id: sprint
        run: |
          LAST=$(git tag --list "sprint_*" | sort -V | tail -n1)
          if [ -z "$LAST" ]; then
             NEXT="sprint_1"
          else
             NUM=$(echo "$LAST" | grep -oE '[0-9]+$')
             NEXT="sprint_$((NUM+1))"
          fi
          echo "last_tag=$LAST" >> $GITHUB_OUTPUT
          echo "new_tag=$NEXT" >> $GITHUB_OUTPUT
          echo "Last Tag: $LAST | Next Tag: $NEXT"

      # -------------------------------------------------------------------------
      # 3. Extract only PROD commits — exclude feature→release & feature→feature
      # -------------------------------------------------------------------------
      - name: Collect clean commit list for release notes
        id: commits
        run: |
          LAST="${{ steps.sprint.outputs.last_tag }}"
          echo "Collecting commits from $LAST to ${TARGET_BRANCH}..."

          if [ -z "$LAST" ]; then
            RANGE="${TARGET_BRANCH}"
          else
            RANGE="${LAST}..${TARGET_BRANCH}"
          fi

          echo "Collecting commits for release notes..."
          RANGE=$(git describe --tags --abbrev=0)..HEAD || RANGE=HEAD

          git log $RANGE --pretty=format:"%s" \
            | grep -Ev -i \
              -e "^merge pull request #[0-9]+.*from.*/test/feature-" \
              -e "release/test\s*←\s*test/feature-" \
              -e "test/feature-.*→.*release/test" \
              -e "merge pull request #[0-9]+.*from.*/feature/" \
            > commits.txt

          echo "Filtered commits (included in release):"
          cat commits.txt || echo "No commits found after filtering."
          echo "============================================="

      # -------------------------------------------------------------------------
      # 4. Create and push tag
      # -------------------------------------------------------------------------
      - name: Create and push new tag
        env:
          TOKEN: ${{ secrets.SUNIL3 }}
        run: |
          TAG=${{ steps.sprint.outputs.new_tag }}
          HEAD_SHA=$(git rev-parse ${TARGET_BRANCH})

          git tag -a "$TAG" "$HEAD_SHA" -m "Sprint Release $TAG"
          git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git "refs/tags/$TAG"

          echo "✅ Tag $TAG created and pushed successfully."

      # -------------------------------------------------------------------------
      # 5. Create GitHub Release via API (no 'What's Changed')
      # -------------------------------------------------------------------------
      - name: Create GitHub Release via API
        env:
          TOKEN: ${{ secrets.SUNIL3 }}
          TAG: ${{ steps.sprint.outputs.new_tag }}
          TARGET_BRANCH: ${{ env.TARGET_BRANCH }}
        run: |
          OWNER=$(echo "$REPO" | cut -d'/' -f1)
          REPO_NAME=$(echo "$REPO" | cut -d'/' -f2)

          echo "Preparing clean release notes (without What's Changed)..."

          if [ -s commits.txt ]; then
            CUSTOM_BODY=$(cat commits.txt)
          else
            CUSTOM_BODY="No new changes detected for this release."
          fi

          PAYLOAD=$(jq -n \
            --arg tag "$TAG" \
            --arg target "$TARGET_BRANCH" \
            --arg name "Sprint Release $TAG" \
            --arg body "$CUSTOM_BODY" \
            '{ tag_name:$tag, target_commitish:$target, name:$name, body:$body, draft:false, prerelease:false }')

          echo "Creating release for $TAG..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.github.com/repos/${OWNER}/${REPO_NAME}/releases" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "Response:"
          echo "$RESPONSE"
