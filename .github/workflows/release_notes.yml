name: Production Release Tag (Native CLI/API)

on:
  pull_request:
    types: [closed]
    branches:
      - 'test/PROD'

jobs:
  create-prod-release:
    runs-on: ubuntu-latest
    env:
      TARGET_BRANCH: "test/PROD"
      GITHUB_API: "https://api.github.com"
      REPO: ${{ github.repository }}
    
    # Check if the PR was merged AND the title starts with "sprint release:" AND the target is 'test/prod'
    if: |
      github.event.pull_request.merged == true && 
      startsWith(github.event.pull_request.pull_request.title, 'sprint release:') &&
      github.event.pull_request.base.ref == 'test/PROD'
      
    # Required permissions to write tags and releases
    permissions:
      contents: write
      pull-requests: read
      
    steps:
      - name: Checkout repository history
        # We need history to find existing tags, but must avoid 'uses: actions/checkout@v4'
        run: |
          git clone --single-branch --depth 1 https://x-access-token:${TOKEN}@github.com/${{ github.repository }} .
          cd ${{ github.repository }}
          git fetch origin --tags 
          
      - name: Calculate Next Sprint Tag
        id: get_tag
        working-directory: ${{ github.repository }}
        run: |
          # 1. Find the highest existing 'sprint_X' tag
          LAST_TAG=$(git tag --list 'sprint_*' | sort -V | tail -n 1)
          
          if [ -z "$LAST_TAG" ]; then
            NEW_TAG="sprint_1"
          else
            # 2. Extract number (gracefully handling missing tags)
            NUM=$(echo "$LAST_TAG" | sed 's/sprint_//g')
            if ! [[ "$NUM" =~ ^[0-9]+$ ]]; then
              echo "Warning: Could not parse number from $LAST_TAG. Defaulting to sprint_1"
              NEXT=1
            else
              NEXT=$((NUM + 1))
            fi
            NEW_TAG="sprint_${NEXT}"
          fi
          
          # 3. Output the new tag name for subsequent steps
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "Calculated new tag: $NEW_TAG"

      - name: Create Release via GitHub API
        env:
          # Use the GITHUB_TOKEN provided by GitHub Actions
          GH_TOKEN: ${{ secrets.SUNIL3 }}
          NEW_TAG: ${{ env.NEW_TAG }}
          # The commit SHA that the PR merged into 'test/prod'
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
          REPO: ${{ github.repository }}
          
        run: |
          echo "Creating release with tag: $NEW_TAG"
          
          # Use curl command to hit the GitHub API
          curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/releases" \
            -d '{
              "tag_name": "'"$NEW_TAG"'",
              "target_commitish": "'"$MERGE_SHA"'", 
              "name": "Release: '"$NEW_TAG"'",
              "body": "Automatically generated release notes for features promoted to PROD.",
              "draft": false,
              "prerelease": false,
              "generate_release_notes": true 
            }'
          
          echo "Release creation initiated for tag $NEW_TAG on commit $MERGE_SHA."
